local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local plr = Players.LocalPlayer
local pg = plr.PlayerGui

-- ÂΩªÂ∫ïÊ∏ÖÁêÜÊóßUI
local oldGui = pg:FindFirstChild("MiniESP")
if oldGui then oldGui:Destroy() end
local oldToggle = pg:FindFirstChild("MiniESP_Toggle")
if oldToggle then oldToggle:Destroy() end

-- Ê†∏ÂøÉÂºÄÂÖ≥
local showNPC = true
local showPrompt = true
local showClick = true
local showItems = true
local godmode = false
local clickKill = false
local respawnAtDeath = false

-- Êï∞ÊçÆ
local espList = {}
local itemList = {}
local registered = {}
local searchKeyword = ""
local deathCFrame = nil

-- Ê∏ÖÈô§ESP
local function clearAllESP()
    for _, d in Workspace:GetDescendants() do
        if d.Name == "ESP_HL" or d.Name == "ESP_Text" then d:Destroy() end
    end
end

-- ÊâæÊúÄËøëBasePart
local function findNearestPart(obj)
    if not obj then return nil end
    for _ = 1, 50 do
        if obj:IsA("BasePart") then return obj end
        obj = obj.Parent
        if not obj then break end
    end
    return nil
end

-- ÁªòÂà∂ESPÔºà‰ªÖ‰øÆÊîπ‰∫íÂä®ÈÄèËßÜÊñáÂ≠ó‰∏∫ÁôΩËâ≤Ôºâ
local function drawESP(part, text, color)
    if not part or not part:IsA("BasePart") or not part:IsDescendantOf(Workspace) then return end
    local hl = part:FindFirstChild("ESP_HL") or Instance.new("Highlight")
    hl.Name = "ESP_HL"
    hl.FillTransparency = 0.7
    hl.OutlineColor = color
    hl.FillColor = Color3.new(0,1,1)
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Parent = part

    local bg = part:FindFirstChild("ESP_Text") or Instance.new("BillboardGui")
    bg.Name = "ESP_Text"
    bg.Adornee = part
    bg.Size = UDim2.new(0,120,0,20)
    bg.StudsOffset = Vector3.new(0,2,0)
    bg.AlwaysOnTop = true
    bg.Parent = part

    local txt = bg:FindFirstChild("TextLabel") or Instance.new("TextLabel")
    txt.Size = UDim2.new(1,0,1,0)
    txt.BackgroundTransparency = 1

    -- ‰ªÖ‰øÆÊîπÔºö‰∫íÂä®ÈÄèËßÜÊñáÂ≠óÊîπ‰∏∫ÁôΩËâ≤ÔºåÂÖ∂‰ªñ‰øùÊåÅÂéüÈ¢úËâ≤
    if color == Color3.new(0,1,0) then -- ÁªøËâ≤È´ò‰∫Æ = ‰∫íÂä®ÈÄèËßÜ
        txt.TextColor3 = Color3.new(1,1,1)
    else
        txt.TextColor3 = color
    end

    txt.TextSize = 11
    txt.TextStrokeTransparency = 0
    txt.TextStrokeColor3 = Color3.new(0,0,0)
    txt.Parent = bg
end

-- ÂîØ‰∏ÄID
local function getUniqueId(part)
    if not part then return nil end
    return string.format("%s_%s", part:GetFullName(), tostring(part.Position))
end

-- Êâ´Êèè
local function scanAll()
    clearAllESP()
    table.clear(espList)
    table.clear(itemList)
    table.clear(registered)
    for _, obj in Workspace:GetDescendants() do
        local part, displayName, objType = nil, nil, nil
        if obj:IsA("ProximityPrompt") then
            part = findNearestPart(obj)
            if part then displayName = "[E] "..part.Name; objType = "prompt" end
        elseif obj:IsA("ClickDetector") then
            part = findNearestPart(obj)
            if part then displayName = "[C] "..part.Name; objType = "click" end
        elseif obj:IsA("Model") and obj:FindFirstChildOfClass("Humanoid") then
            local isPlayer = false
            for _, p in Players:GetPlayers() do if p.Character == obj then isPlayer = true break end end
            if not isPlayer then
                part = obj.PrimaryPart or findNearestPart(obj)
                if part then displayName = "[NPC] "..obj.Name; objType = "npc" end
            end
        elseif obj:IsA("Tool") or obj:IsA("Part") then
            local isItem = obj.Name:lower():find("item") or obj.Name:lower():find("tool") or obj.Name:lower():find("key")
            if isItem then
                part = obj:IsA("BasePart") and obj or findNearestPart(obj)
                if part then displayName = "[ITEM] "..obj.Name; objType = "item" end
            end
        end
        if part and objType and displayName then
            local uid = getUniqueId(part)
            if uid and not registered[uid] then
                registered[uid] = true
                table.insert(espList, {name=displayName, part=part, type=objType})
                if objType == "item" then table.insert(itemList, {name=displayName, part=part}) end
            end
        end
    end
    -- Êâ´ÊèèÂêéÈáçÂª∫ÊâÄÊúâESPÂÖÉÁ¥†ÔºåÁ°Æ‰øùÊñáÂ≠óÂíåÈ´ò‰∫ÆÂ≠òÂú®
    for _, v in ipairs(espList) do
        if v.part and v.part:IsDescendantOf(Workspace) then
            local c = Color3.new(1,1,1)
            if v.type == "npc" then c=Color3.new(1,1,0) end
            if v.type == "prompt" then c=Color3.new(0,1,0) end
            if v.type == "click" then c=Color3.new(1,0,0) end
            if v.type == "item" then c=Color3.new(0,1,1) end
            drawESP(v.part, v.name, c)
        end
    end
    updateItemList()
    updateList()
    updateButtonColors()
end

-- Êõ¥Êñ∞ÈÄèËßÜ & ÂÆûÊó∂Âà∑Êñ∞Ë∑ùÁ¶ª
function updateVisual()
    local root = plr.Character and plr.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    for _, v in ipairs(espList) do
        if not v.part or not v.part:IsDescendantOf(Workspace) then continue end
        local show = false
        if v.type == "npc" and showNPC then show = true end
        if v.type == "prompt" and showPrompt then show = true end
        if v.type == "click" and showClick then show = true end
        if v.type == "item" and showItems then show = true end

        local txt = v.part:FindFirstChild("ESP_Text") and v.part.ESP_Text:FindFirstChild("TextLabel")
        if txt then
            if show then
                local dist = math.floor((v.part.Position - root.Position).Magnitude)
                txt.Text = string.format("%s [Ë∑ùÁ¶ª:%s]", v.name, dist)
                txt.Visible = true
                local hl = v.part:FindFirstChild("ESP_HL")
                if hl then hl.Enabled = true end
            else
                txt.Visible = false
                local hl = v.part:FindFirstChild("ESP_HL")
                if hl then hl.Enabled = false end
            end
        end
    end
end

-- Êó†Á¢∞Êíû
local function setCollide(state)
    if not plr.Character then return end
    for _, v in plr.Character:GetDescendants() do
        if v:IsA("BasePart") then
            v.CanCollide = state
            v.CanTouch = state
            v.CanQuery = state
        end
    end
end

-- ÂéüÂú∞Â§çÊ¥ª
plr.CharacterAdded:Connect(function(char)
    repeat task.wait() until char:FindFirstChild("HumanoidRootPart") and char:FindFirstChildOfClass("Humanoid")
    local hum = char:FindFirstChildOfClass("Humanoid")
    local root = char.HumanoidRootPart
    hum.Died:Connect(function()
        deathCFrame = root.CFrame
        if respawnAtDeath then
            plr:LoadCharacter()
        end
    end)
    if respawnAtDeath and deathCFrame then
        task.wait(0.2)
        root.CFrame = deathCFrame * CFrame.new(0, 1, 0)
    end
    if godmode then setCollide(false) end
end)

-- ÁÇπË∞ÅË∞ÅÊ≠ª
UserInputService.TouchTap:Connect(function(touchPositions)
    if not clickKill or not plr.Character then return end
    local cam = Workspace.CurrentCamera
    local pos = touchPositions[1]
    local ray = cam:ViewportPointToRay(pos.X, pos.Y)
    local params = RaycastParams.new()
    params.FilterDescendantsInstances = {plr.Character}
    params.FilterType = Enum.RaycastFilterType.Blacklist
    local res = Workspace:Raycast(ray.Origin, ray.Direction*5000, params)
    if res then
        local char = res.Instance:FindFirstAncestorOfClass("Model")
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        if hum and hum.Health > 0 then
            local isPlayer = false
            for _, p in Players:GetPlayers() do if p.Character == char then isPlayer = true break end end
            if not isPlayer then hum.Health = 0 end
        end
    end
end)

-- ==================== ‰∏ªÈù¢ÊùøUI ====================
local gui = Instance.new("ScreenGui")
gui.Name = "MiniESP"
gui.ResetOnSpawn = false
gui.Parent = pg

local window = Instance.new("Frame")
window.Name = "Window"
window.Size = UDim2.new(0,260,0,480)
window.Position = UDim2.new(0,20,0,20)
window.BackgroundColor3 = Color3.new(0.1,0.1,0.12)
window.BackgroundTransparency = 0.1
window.Visible = true
window.Parent = gui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0,6)
corner.Parent = window

-- ÊãñÂä®Ê†è
local bar = Instance.new("TextLabel")
bar.Size = UDim2.new(1,0,0,22)
bar.BackgroundTransparency = 1
bar.Text = "ESP Panel (ÊãñÂä®)"
bar.TextColor3 = Color3.new(1,1,1)
bar.TextSize = 14
bar.Parent = window

-- ÊåâÈíÆ
local buttons = {}
local function MakeButton(name, txt, x, y, callback)
    local b = Instance.new("TextButton")
    b.Name = name
    b.Size = UDim2.new(0,120,0,28)
    b.Position = UDim2.new(0,x,0,y)
    b.Text = txt
    b.TextColor3 = Color3.new(1,1,1)
    b.TextSize = 13
    b.Parent = window
    b.MouseButton1Click:Connect(callback)
    local bc = Instance.new("UICorner")
    bc.CornerRadius = UDim.new(0,4)
    bc.Parent = b
    buttons[name] = b
end

MakeButton("scan", "üîÑ Êâ´Êèè",5,25, scanAll)
MakeButton("god", "‚≠ê Êó†Á¢∞Êíû",130,25,function()
    godmode = not godmode
    setCollide(not godmode)
    updateButtonColors()
end)
MakeButton("npc", "üë§ NPC",5,55,function()
    showNPC = not showNPC
    updateButtonColors()
end)
MakeButton("prompt", "üí¨ ‰∫íÂä®",130,55,function()
    showPrompt = not showPrompt
    updateButtonColors()
end)
MakeButton("click", "üî¥ ÁÇπÂáª",5,85,function()
    showClick = not showClick
    updateButtonColors()
end)
MakeButton("item", "üì¶ Áâ©ÂìÅ",130,85,function()
    showItems = not showItems
    updateButtonColors()
end)
MakeButton("clickkill", "ü©∏ ÁÇπË∞ÅË∞ÅÊ≠ª",5,115,function()
    clickKill = not clickKill
    updateButtonColors()
end)
MakeButton("respawn", "‚ôªÔ∏è ÂéüÂú∞Â§çÊ¥ª",130,115,function()
    respawnAtDeath = not respawnAtDeath
    updateButtonColors()
end)

-- ÊåâÈíÆÈ¢úËâ≤
function updateButtonColors()
    buttons.god.BackgroundColor3 = godmode and Color3.new(1,0.6,0) or Color3.new(0.15,0.15,0.15)
    buttons.npc.BackgroundColor3 = showNPC and Color3.new(0,0.6,0) or Color3.new(0.15,0.15,0.15)
    buttons.prompt.BackgroundColor3 = showPrompt and Color3.new(0,0.6,0) or Color3.new(0.15,0.15,0.15)
    buttons.click.BackgroundColor3 = showClick and Color3.new(1,0,0) or Color3.new(0.15,0.15,0.15)
    buttons.item.BackgroundColor3 = showItems and Color3.new(0,0.6,0) or Color3.new(0.15,0.15,0.15)
    buttons.clickkill.BackgroundColor3 = clickKill and Color3.new(0.5,0,0) or Color3.new(0.15,0.15,0.15)
    buttons.respawn.BackgroundColor3 = respawnAtDeath and Color3.new(0,0.7,1) or Color3.new(0.15,0.15,0.15)
end

-- Áâ©ÂìÅÂàóË°®
local itemFrame = Instance.new("Frame")
itemFrame.Size = UDim2.new(1,-10,0,150)
itemFrame.Position = UDim2.new(0,5,0,148)
itemFrame.BackgroundTransparency = 1
itemFrame.Parent = window

local itemTitle = Instance.new("TextLabel")
itemTitle.Size = UDim2.new(1,0,0,18)
itemTitle.BackgroundTransparency = 1
itemTitle.Text = "Áâ©ÂìÅÂàóË°®"
itemTitle.TextColor3 = Color3.new(0.8,0.8,0.8)
itemTitle.TextSize = 12
itemTitle.Parent = itemFrame

local itemScroll = Instance.new("ScrollingFrame")
itemScroll.Size = UDim2.new(1,0,1,-18)
itemScroll.Position = UDim2.new(0,0,0,18)
itemScroll.BackgroundTransparency = 1
itemScroll.ScrollBarThickness = 3
itemScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
itemScroll.Parent = itemFrame

local ilay = Instance.new("UIListLayout")
ilay.Parent = itemScroll
ilay.SortOrder = Enum.SortOrder.Name
ilay.Padding = UDim.new(0,2)

function updateItemList()
    for _, c in itemScroll:GetChildren() do if c:IsA("TextLabel") then c:Destroy() end end
    for _, v in ipairs(itemList) do
        local t = Instance.new("TextLabel")
        t.Size = UDim2.new(1,0,0,20)
        t.BackgroundTransparency = 1
        t.Text = "‚Ä¢ "..v.name
        t.TextColor3 = Color3.new(1,1,1)
        t.TextSize = 12
        t.Parent = itemScroll
        t.TextXAlignment = Enum.TextXAlignment.Center
        t.TextTruncate = Enum.TextTruncate.AtEnd
        t.ClipsDescendants = true
    end
end

-- ‰º†ÈÄÅÂàóË°®+ÊêúÁ¥¢
local tpFrame = Instance.new("Frame")
tpFrame.Size = UDim2.new(1,-10,0,150)
tpFrame.Position = UDim2.new(0,5,0,310)
tpFrame.BackgroundTransparency = 1
tpFrame.Parent = window

local tpTitle = Instance.new("TextLabel")
tpTitle.Size = UDim2.new(1,0,0,18)
tpTitle.BackgroundTransparency = 1
tpTitle.Text = "‰º†ÈÄÅÂàóË°®"
tpTitle.TextColor3 = Color3.new(0.8,0.8,0.8)
tpTitle.TextSize = 12
tpTitle.Parent = tpFrame

-- ÊêúÁ¥¢Ê°Ü
local searchBox = Instance.new("TextBox")
searchBox.Name = "SearchBox"
searchBox.Size = UDim2.new(1,0,0,22)
searchBox.Position = UDim2.new(0,0,0,18)
searchBox.BackgroundColor3 = Color3.new(0.15,0.15,0.18)
searchBox.BackgroundTransparency = 0.2
searchBox.TextColor3 = Color3.new(1,1,1)
searchBox.PlaceholderText = "ÊêúÁ¥¢ NPC / ‰∫íÂä® / Áâ©ÂìÅ..."
searchBox.PlaceholderColor3 = Color3.new(0.6,0.6,0.6)
searchBox.TextSize = 12
searchBox.Text = ""
searchBox.ClearTextOnFocus = false
searchBox.Parent = tpFrame

local searchCorner = Instance.new("UICorner")
searchCorner.CornerRadius = UDim.new(0,4)
searchCorner.Parent = searchBox

-- ‰º†ÈÄÅÊªöÂä®
local tpScroll = Instance.new("ScrollingFrame")
tpScroll.Size = UDim2.new(1,0,1,-40)
tpScroll.Position = UDim2.new(0,0,0,40)
tpScroll.BackgroundTransparency = 1
tpScroll.ScrollBarThickness = 3
tpScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
tpScroll.Parent = tpFrame

local tlay = Instance.new("UIListLayout")
tlay.Parent = tpScroll
tlay.SortOrder = Enum.SortOrder.Name
tlay.Padding = UDim.new(0,2)

-- ÊêúÁ¥¢ÂÆûÊó∂ËøáÊª§
searchBox:GetPropertyChangedSignal("Text"):Connect(function()
    searchKeyword = string.lower(searchBox.Text)
    updateList()
end)

-- ‰º†ÈÄÅÂàóË°®
function updateList()
    for _, c in tpScroll:GetChildren() do if c:IsA("TextButton") then c:Destroy() end end
    local lowerKey = string.lower(searchKeyword or "")
    for _, v in ipairs(espList) do
        if not v.part or not v.part:IsDescendantOf(Workspace) then continue end
        local lowerName = string.lower(v.name or "")
        if lowerKey == "" or string.find(lowerName, lowerKey, 1, true) then
            local b = Instance.new("TextButton")
            b.Size = UDim2.new(1,0,0,20)
            b.BackgroundTransparency = 1
            b.Text = v.name
            b.TextColor3 = Color3.new(1,1,1)
            b.TextSize = 12
            b.Parent = tpScroll
            b.TextXAlignment = Enum.TextXAlignment.Center
            b.TextTruncate = Enum.TextTruncate.AtEnd
            b.ClipsDescendants = true
            b.MouseButton1Click:Connect(function()
                local root = plr.Character and plr.Character:FindFirstChild("HumanoidRootPart")
                if root and v.part:IsDescendantOf(Workspace) then
                    root.CFrame = v.part.CFrame * CFrame.new(0,2,-3)
                end
            end)
        end
    end
end

-- ==================== ‰∏ªÈù¢ÊùøÊãñÂä® ====================
local drag = false
local offset = Vector2.new(0, 0)
bar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        drag = true
        offset = Vector2.new(input.Position.X - window.AbsolutePosition.X, input.Position.Y - window.AbsolutePosition.Y)
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if drag and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        window.Position = UDim2.new(0, input.Position.X - offset.X, 0, input.Position.Y - offset.Y)
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        drag = false
    end
end)

-- ==================== Â∞èÂºÄÂÖ≥UI ====================
local toggleGui = Instance.new("ScreenGui")
toggleGui.Name = "MiniESP_Toggle"
toggleGui.ResetOnSpawn = false
toggleGui.Parent = pg

local dragArea = Instance.new("Frame")
dragArea.Name = "DragArea"
dragArea.Size = UDim2.new(0,90,0,90)
dragArea.Position = UDim2.new(0,300,0,20)
dragArea.BackgroundTransparency = 1
dragArea.Parent = toggleGui

local toggleContainer = Instance.new("Frame")
toggleContainer.Name = "ToggleContainer"
toggleContainer.Size = UDim2.new(1,0,1,0)
toggleContainer.BackgroundTransparency = 1
toggleContainer.Parent = dragArea

local toggleBtn = Instance.new("TextButton")
toggleBtn.Name = "TogglePanel"
toggleBtn.Size = UDim2.new(0,50,0,50)
toggleBtn.Position = UDim2.new(0.5,-25,0.5,-25)
toggleBtn.BackgroundColor3 = Color3.new(0.15,0.15,0.15)
toggleBtn.BackgroundTransparency = 0.3
toggleBtn.Text = "üìå"
toggleBtn.TextColor3 = Color3.new(1,1,1)
toggleBtn.TextSize = 18
toggleBtn.Parent = toggleContainer

local btnCorner = Instance.new("UICorner")
btnCorner.CornerRadius = UDim.new(0,4)
btnCorner.Parent = toggleBtn

local stroke = Instance.new("UIStroke")
stroke.Thickness = 1
stroke.Color = Color3.new(0.4,0.4,0.4)
stroke.Parent = toggleBtn

-- Â∞èÂºÄÂÖ≥ÊãñÂä®
local toggleDrag = false
local toggleOffset = Vector2.new(0, 0)
dragArea.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        toggleDrag = true
        toggleOffset = Vector2.new(input.Position.X - dragArea.AbsolutePosition.X, input.Position.Y - dragArea.AbsolutePosition.Y)
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if toggleDrag and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        dragArea.Position = UDim2.new(0, input.Position.X - toggleOffset.X, 0, input.Position.Y - toggleOffset.Y)
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        toggleDrag = false
    end
end)

toggleBtn.MouseButton1Click:Connect(function()
    window.Visible = not window.Visible
end)

-- ==================== ÂÆûÊó∂Âà∑Êñ∞Ë∑ùÁ¶ª ====================
RunService.RenderStepped:Connect(function()
    updateVisual()
end)

-- ÂàùÂßãÂåñ
scanAll()
updateButtonColors()
